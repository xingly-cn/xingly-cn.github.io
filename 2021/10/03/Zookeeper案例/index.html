<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Sugar">
    
    <title>
        
            Zookeeper实现 |
        
        Fang Tang Space
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"https://xpoet.cn/images/bg.svg","description":"黄色的森林分出两条路，我选择了人迹更少的那一条，从此决定我一生的道路。"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Fang Tang Space
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                LINKS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/changelog"
                            >
                                CHANGELOG
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">LINKS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/changelog">CHANGELOG</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Zookeeper实现</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Sugar</span>
                        
                            <span class="author-label">Lv5</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2021-10-03 12:35:00</span>
        <span class="mobile">2021-10-03 12:35</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/java/">java</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/RPC/">RPC</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">分布式锁</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%8A%A8%E6%80%81%E4%B8%8A%E4%B8%8B%E7%BA%BF%E7%9B%91%E5%90%AC/">动态上下线监听</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="Zookeeper集群"><a href="#Zookeeper集群" class="headerlink" title="Zookeeper集群"></a>Zookeeper集群</h1><h2 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h2><h3 id="选举机制（面试重点）"><a href="#选举机制（面试重点）" class="headerlink" title="选举机制（面试重点）"></a>选举机制（面试重点）</h3><ul>
<li>第一次启动</li>
</ul>
<p>假设这里有5台服务器，首先第1台启动，投1号一票；第2台启动，投2号一票，由于2号的<code>myid</code>大于1号的，所以1号的票转移给2号，此时2号两票；第三台启动，同样的2号的票转移给3号，此时3号三票（大于半数），选举完成3号成为leader，1，2号为follower；此时4号，5号启动更改状态为follower。</p>
<blockquote>
<p>了解一下</p>
</blockquote>
<p>SID :  服务器ID，与myid相同。</p>
<p>ZXID :  事务ID，标识服务器状态的改变。</p>
<p>Epoch ：Leader任期的代号，无Leader时同一轮投票的逻辑时钟相同，投完票增加。</p>
<p>总结：myid中间的节点，成为leader</p>
<ul>
<li>第二次启动</li>
</ul>
<blockquote>
<p>什么时候会发生Leader选举？</p>
</blockquote>
<p>1 ）、服务器第一次启动时</p>
<p>2 ）、服务器无法与Leader保持连接</p>
<blockquote>
<p>Leader选举时，会出现两种状态</p>
</blockquote>
<p>1 ）、Leader存在，只是你没连上而已</p>
<p>​    机器试图选举时，会被告知当前Leader信息，直到与Leader连上为止，并状态同步。</p>
<p>2 ）、Leader确实挂了</p>
<p>​    假设5台服务器，SID分别为1、2、3、4、5，ZXID分别为8、8、8、7、7，此时3号为Leader。突然3和5号服务器挂掉，开始选举。此时存活的有1、2、4服务器，依次比较（Epoch，ZXIDI，SID）谁大谁当Leader。</p>
<h3 id="集群启停脚本"><a href="#集群启停脚本" class="headerlink" title="集群启停脚本"></a>集群启停脚本</h3><blockquote>
<p>要求：提前配好三台Linux免密登录，否则没有权限</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;start&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> zkServer1 zkServer2 zkServer3</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> ---------- zookeeper <span class="variable">$i</span> start ----------</span><br><span class="line">                ssh <span class="variable">$i</span> <span class="string">&quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line"><span class="string">&quot;stop&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> zkServer1 zkServer2 zkServer3</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> ---------- zookeeper <span class="variable">$i</span> stop ----------</span><br><span class="line">                ssh <span class="variable">$i</span> <span class="string">&quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line"><span class="string">&quot;status&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> zkServer1 zkServer2 zkServer3</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> ---------- zookeeper <span class="variable">$i</span> status ----------</span><br><span class="line">                ssh <span class="variable">$i</span> <span class="string">&quot;/opt/module/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>使用方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量启动</span></span><br><span class="line">zk.sh start</span><br><span class="line"><span class="comment"># 批量停止</span></span><br><span class="line">zk.sh stop</span><br><span class="line"><span class="comment"># 批量状态查询</span></span><br><span class="line">zk.sh status</span><br></pre></td></tr></table></figure>



<blockquote>
<p>再提供一个zoo.cfg配置集群分发删除脚本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> zkServer1 zkServer2 zkServer3</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> ---------- zookeeper <span class="variable">$i</span> zoo.cfg <span class="built_in">sync</span> ----------</span><br><span class="line">                ssh <span class="variable">$i</span> <span class="string">&quot;cd conf文件夹路径 &amp;&amp; wget zoo.cfg下载路径&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">;;</span><br><span class="line"><span class="string">&quot;delete&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> zkServer1 zkServer2 zkServer3</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                <span class="built_in">echo</span> ---------- zookeeper <span class="variable">$i</span> zoo.cfg delete ----------</span><br><span class="line">                ssh <span class="variable">$i</span> <span class="string">&quot;cd conf文件夹路径 &amp;&amp; rm -f zoo.cfg&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>

<p>使用方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量删除zoo.cfg</span></span><br><span class="line">tb.sh delete</span><br><span class="line"><span class="comment"># 批量更新zoo.cfg</span></span><br><span class="line">tb.sh <span class="built_in">sync</span></span><br></pre></td></tr></table></figure>



<h2 id="客户端命令行操作"><a href="#客户端命令行操作" class="headerlink" title="客户端命令行操作"></a>客户端命令行操作</h2><h3 id="命令行语法"><a href="#命令行语法" class="headerlink" title="命令行语法"></a>命令行语法</h3><table>
<thead>
<tr>
<th>基本语法</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>help</td>
<td>显示所有命令</td>
</tr>
<tr>
<td>ls path</td>
<td>查询当前znode子节点[可监听]，-w 子节点变化，-s 次级信息</td>
</tr>
<tr>
<td>create</td>
<td>创建节点，-s 有序列，-e 临时</td>
</tr>
<tr>
<td>get path</td>
<td>获得节点值[可监听]，-w 节点内容变化，-s 次级信息</td>
</tr>
<tr>
<td>set</td>
<td>设置节点的值</td>
</tr>
<tr>
<td>stat</td>
<td>节点状态</td>
</tr>
<tr>
<td>delete</td>
<td>删除节点</td>
</tr>
<tr>
<td>deleteall</td>
<td>递归删除节点</td>
</tr>
</tbody></table>
<blockquote>
<p>进入命令行</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zkCli.sh -server zkServer1:2181</span><br></pre></td></tr></table></figure>



<h3 id="znode信息"><a href="#znode信息" class="headerlink" title="znode信息"></a>znode信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[zookeeper]cZxid = 0x0</span><br><span class="line">ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">mZxid = 0x0</span><br><span class="line">mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">pZxid = 0x0</span><br><span class="line">cversion = -1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 1</span><br></pre></td></tr></table></figure>

<p>1 ）czxid：创建节点的事务zxid</p>
<p>2 ）ctime：创建时间（毫秒）</p>
<p>3 ）mzxid：最后更新的事务zxid</p>
<p>4 ）mtime：自后修改的时间（毫秒）</p>
<p>5 ）pzxid：最后更新的子节点zxid</p>
<p>6 ）cversion：子节点变化号，修改次数</p>
<p>7 ）dataversion：数据变化号，修改次数</p>
<p>8 ）aclVersion：控制列表变化号</p>
<p>9 ）ephemeralOwner：若是临时节点，则是znode的session id，否则为0</p>
<h3 id="节点类型（持久-x2F-短暂-x2F-有序号-x2F-无序号）"><a href="#节点类型（持久-x2F-短暂-x2F-有序号-x2F-无序号）" class="headerlink" title="节点类型（持久&#x2F;短暂&#x2F;有序号&#x2F;无序号）"></a>节点类型（持久&#x2F;短暂&#x2F;有序号&#x2F;无序号）</h3><p><img src="https://i.loli.net/2021/10/01/3L6czMnF1qxi5eW.png" alt="image-20211001220638643"></p>
<ul>
<li><p>持久节点</p>
<p>客户端与服务端断开后，节点不删除</p>
</li>
<li><p>短暂节点</p>
<p>客户端与服务端断开后，节点删除</p>
</li>
<li><p>无序</p>
<p>正常znode名称</p>
</li>
<li><p>有序</p>
<p>原有znode名称后 + 顺序号</p>
</li>
</ul>
<p>1 ）创建两个永久节点（不带序号）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建</span></span><br><span class="line">create /sanguo <span class="string">&quot;diaochan&quot;</span></span><br><span class="line">create /sanguo/shuguo <span class="string">&quot;liubei&quot;</span></span><br><span class="line"><span class="comment"># 查询</span></span><br><span class="line">get -s /sanguo</span><br><span class="line">get -s /sanguo/shuguo</span><br></pre></td></tr></table></figure>

<p>2 ）创建两个永久节点（带序号）</p>
<p>znode可以重名，因为顺序号+1不同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -s /sanguo/weiguo/zhangliao <span class="string">&quot;zhangliao&quot;</span></span><br></pre></td></tr></table></figure>

<p>3 ）创建一个临时节点（不带序号）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e /sanguo/wuguo <span class="string">&quot;zhouyu&quot;</span></span><br></pre></td></tr></table></figure>

<p>4 ）创建一个临时节点（带序号）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create -e -s /sanguo/wuguo <span class="string">&quot;zhouyu&quot;</span></span><br></pre></td></tr></table></figure>

<p>5 ）修改节点值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> /sanguo/weiguo <span class="string">&quot;simayi&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="监听器原理"><a href="#监听器原理" class="headerlink" title="监听器原理"></a>监听器原理</h3><p><img src="https://i.loli.net/2021/10/01/GSpUo4y3P2XrxRu.png" alt="image-20211001223417543"></p>
<p>监听流程：</p>
<ol>
<li>有一个<code>main()</code>线程</li>
<li><code>main</code>线程中创建zk客户端，创建<code>connect</code>和<code>listener</code>线程</li>
<li>通过<code>connect</code>将<code>监听事件</code>发送给zk服务端</li>
<li>zk服务端将<code>监听事件</code>加入<code>监听器列表</code></li>
<li>zk服务器监听到<code>数据或路径</code>变化，将消息发送给<code>listener</code>线程</li>
<li><code>listener</code>线程调用<code>process()</code>方法</li>
</ol>
<p>常见监听：</p>
<ol>
<li>监听节点数据变化，<code>get path [watch]</code></li>
<li>监听子节点增减变化，<code>ls path [watch]</code></li>
</ol>
<blockquote>
<p>监听节点数据变化模拟</p>
</blockquote>
<p>3号服务器上监听<code>get -w /sanguo</code>，1号服务器上修改<code>set /sanguo &quot;xnx&quot;</code>，3号命令行出现<code>WatchedEvent state:SyncConnected type:NodeDataChanged path:/sanguo</code>，成功监听。</p>
<p>TIP：&#x3D;&#x3D;只能监听一次修改，如果想要再监听，需要重新注册监听&#x3D;&#x3D;</p>
<blockquote>
<p>监听节点数变化模拟</p>
</blockquote>
<p>3号服务器上监听<code>ls -w /sanguo</code>，1号服务器上修改<code>create /sanguo/jin &quot;simayi&quot;</code>，3号命令行出现<code>WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/sanguo</code>，成功监听。</p>
<h3 id="节点删除与查看"><a href="#节点删除与查看" class="headerlink" title="节点删除与查看"></a>节点删除与查看</h3><ol>
<li><p>单个删除，<code>delete /sanguo/jin</code></p>
</li>
<li><p>递归删除，<code>deleteall /sanguo</code></p>
</li>
<li><p>查看节点状态，<code>stat /zookeeper</code></p>
</li>
</ol>
<h2 id="客户端API操作"><a href="#客户端API操作" class="headerlink" title="客户端API操作"></a>客户端API操作</h2><h3 id="pom依赖"><a href="#pom依赖" class="headerlink" title="pom依赖"></a>pom依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">junit</span><br><span class="line">zookeeper</span><br><span class="line">log4j-core</span><br></pre></td></tr></table></figure>



<h3 id="创建zkClient"><a href="#创建zkClient" class="headerlink" title="创建zkClient"></a>创建zkClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sugar.zk;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.WatchedEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.Watcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.ZooKeeper;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">zkClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;zkServer1:2181,zkServer2:2181,zkServer3:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">sessionTimeout</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line">	<span class="keyword">private</span> ZooKeeper zkClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        zkClient = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(ip, Timeout, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="创建子节点"><a href="#创建子节点" class="headerlink" title="创建子节点"></a>创建子节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> zkClient.create(<span class="string">&quot;/xnx&quot;</span>, <span class="string">&quot;ss.avi&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="获取子节点并监听变化"><a href="#获取子节点并监听变化" class="headerlink" title="获取子节点并监听变化"></a>获取子节点并监听变化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getChild</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">       List&lt;String&gt; children = zkClient.getChildren(<span class="string">&quot;/&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;child = &quot;</span> + child);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 延时 For 持续监听</span></span><br><span class="line">       Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>想要持续监听，就在<code>zk客户端</code>的<code>process</code>回调方法里再次注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span>	</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">	List&lt;String&gt; children = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 每次监听完，再次注册</span></span><br><span class="line">       	children = zkClient.getChildren(<span class="string">&quot;/&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">           <span class="comment">// 打印节点情况</span></span><br><span class="line">       	<span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;child = &quot;</span> + child);</span><br><span class="line">		&#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                 e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                 e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="判断Znode是否存在"><a href="#判断Znode是否存在" class="headerlink" title="判断Znode是否存在"></a>判断Znode是否存在</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exist</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">       <span class="type">Stat</span> <span class="variable">exists</span> <span class="operator">=</span> zkClient.exists(<span class="string">&quot;/wj&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">       System.out.println(exists==<span class="literal">null</span>?<span class="string">&quot;无&quot;</span>:<span class="string">&quot;有&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="客户端向服务器写数据"><a href="#客户端向服务器写数据" class="headerlink" title="客户端向服务器写数据"></a>客户端向服务器写数据</h2><p>写数据有两种情况：①发送给Leader ②发送给follower</p>
<blockquote>
<p>发送给Leader</p>
</blockquote>
<p><img src="https://i.loli.net/2021/10/02/qHyo4ngsuxDQfaw.png" alt="image-20211002210719383"></p>
<p>这里按3台服务器为例：</p>
<ol>
<li>客户端给Leader写数据</li>
<li>客户端给<code>中间的follower</code>写数据</li>
<li>中间follower应答</li>
<li>由于已有2台服务器完成写（超过半数），可以<code>直接应答客服端</code></li>
<li>然后Leader再向剩余follower写数据，并做出回复</li>
</ol>
<blockquote>
<p>发送给follower</p>
</blockquote>
<p><img src="https://i.loli.net/2021/10/02/rzP3BTqbKjocgDk.png" alt="image-20211002211448040"></p>
<ol>
<li>客户端给follower写数据</li>
<li>但是follower<code>无写权限</code>，将写请求转发给Leader</li>
<li>Leader写完之后，向中间follower写数据</li>
<li>中间follower应答</li>
<li>由于已有2台服务器完成写（超过半数），告诉中间follower完成了</li>
<li>中间follower告诉再应答客户端</li>
<li>然后Leader再向剩余follower写数据，并做出回复</li>
</ol>
<p>&#x3D;&#x3D;这里会发现，5这时已有半数服务器完成写，为什么Leader不直接返回给客户端呢？&#x3D;&#x3D;</p>
<p>eg. 客户端是与中间follower建立连接，所以Leader必须告诉中间的follower，再由它来转告客户端。</p>
<h1 id="服务器动态上下线监听案例"><a href="#服务器动态上下线监听案例" class="headerlink" title="服务器动态上下线监听案例"></a>服务器动态上下线监听案例</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>​    某分布式系统，主节点可以有多台，可以动态上下线，任意一台客户端都能实时感知主节点服务器的上下线。</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p><img src="https://i.loli.net/2021/10/02/WHqO3bXkyhCZ1de.png" alt="image-20211002212516309"></p>
<p>​    三台服务器注册信息后，客户端来监听，如果有服务器下线，zk通知客户端XXX下线，客户端重新获取服务器列表，并注册监听。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>1 ）、创建&#x2F;servers节点</p>
<p>​    <code>create /servers &quot;main&quot;</code></p>
<p>2 ）、服务器向zk发起注册</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sugar.case1;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;zkServer1:2181,zkServer2:2181,zkServer3:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="type">DistributeServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributeServer</span>();</span><br><span class="line">        <span class="comment">// 1.获取zk</span></span><br><span class="line">        server.getConnect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.注册</span></span><br><span class="line">        server.regist(args[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.业务（睡觉）</span></span><br><span class="line">        server.business();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//---------------------方法实现--------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">regist</span><span class="params">(String hostname)</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">node</span> <span class="operator">=</span> zk.create(/servers/<span class="string">&quot; + hostname&quot;</span>, hostname.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">        System.out.println(hostname + <span class="string">&quot;已上线&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(ip, time, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3 ）、客户端监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sugar.case1;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;zkServer1:2181,zkServer2:2181,zkServer3:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="type">DistributeClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributeClient</span>();</span><br><span class="line">        <span class="comment">// 1.获取zk</span></span><br><span class="line">        client.getConnect();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.监听 /servers 下面子节点变化</span></span><br><span class="line">        client.getServerList();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.业务（睡觉）</span></span><br><span class="line">        client.business();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">business</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getServerList</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="comment">// 获取servers下所有节点名称</span></span><br><span class="line">        List&lt;String&gt; children = zk.getChildren(<span class="string">&quot;/servers&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        ArrayList&lt;String&gt; servers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String child : children) &#123;</span><br><span class="line">            <span class="comment">// 根据路径 获取所有节点的值</span></span><br><span class="line">            <span class="type">byte</span>[] data = zk.getData(<span class="string">&quot;/servers&quot;</span> + child, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            servers.add(<span class="keyword">new</span> <span class="title class_">String</span>(data));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 打印</span></span><br><span class="line">        System.out.println(servers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(ip, time, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="comment">// 回调继续监听</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    getServerList();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>1 ）、在Linux命令行操作增减服务器</p>
<ol>
<li>启动<code>DistributeClient</code>客户端</li>
<li>在1号服务器的<code>/servers</code>目录创建 临时带序号节点</li>
<li>观察idea控制台信息</li>
<li>执行删除</li>
<li>观察idea控制台信息</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行创建</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] create -e -s /servers/xnx1 <span class="string">&quot;one&quot;</span></span><br><span class="line">Created /servers/xnx10000000001</span><br><span class="line">[zk: localhost:2181(CONNECTED) 18] create -e -s /servers/xnx2 <span class="string">&quot;twe&quot;</span></span><br><span class="line">Created /servers/xnx20000000002</span><br><span class="line">[zk: localhost:2181(CONNECTED) 20] delete /servers/xnx20000000002</span><br><span class="line"></span><br><span class="line"><span class="comment"># IDEA控制台信息</span></span><br><span class="line">[one]</span><br><span class="line">[one, twe]</span><br><span class="line">[one]</span><br></pre></td></tr></table></figure>



<p>2 ）、在IDEA操作增减服务器</p>
<ol>
<li>启动<code>DistributeClient</code>客户端</li>
<li>启动<code>DistributeServer</code>服务端</li>
</ol>
<p><img src="https://i.loli.net/2021/10/02/gusdMiQ2Keh1TEa.png" alt="image-20211002222037112"></p>
<h1 id="Zookeeper分布式锁案例"><a href="#Zookeeper分布式锁案例" class="headerlink" title="Zookeeper分布式锁案例"></a>Zookeeper分布式锁案例</h1><h2 id="原生Zookeeper实现分布式锁"><a href="#原生Zookeeper实现分布式锁" class="headerlink" title="原生Zookeeper实现分布式锁"></a>原生Zookeeper实现分布式锁</h2><blockquote>
<p>什么是分布式锁？</p>
</blockquote>
<p>进程1在访问临界资源时，会获得锁，对该资源独占。其他进程无法访问，等进程1访问完释放锁，其他进程才可以获得锁。为了<code>分布式系统下多个进程有序的访问临界资源</code>。</p>
<h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p><img src="https://i.loli.net/2021/10/02/hOaP7tbBopULvXE.png" alt="image-20211002223413448"></p>
<ol>
<li>客户端访问资源，创建<code>lock</code>临时顺序节点</li>
<li>判断自己是不是最小节点：是，得到锁；不是，对前一个节点监听</li>
<li>获得锁，完成业务，释放节点，其他节点收到通知，重复第二步</li>
</ol>
<h3 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sugar.case2;</span><br><span class="line"><span class="keyword">import</span> org.apache.zookeeper.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributeLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> <span class="string">&quot;zkServer1:2181,zkServer2:2181,zkServer3:2181&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">CountDownLatch</span> <span class="variable">connectLoatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="type">CountDownLatch</span> <span class="variable">waitLoatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> String waitPath;</span><br><span class="line">    <span class="keyword">private</span> String curNode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DistributeLock</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="comment">// 1.获得ck</span></span><br><span class="line">        zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(ip, time, <span class="keyword">new</span> <span class="title class_">Watcher</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent watchedEvent)</span> &#123;</span><br><span class="line">                <span class="comment">// 已成功连接zk，释放connectLoatch</span></span><br><span class="line">                <span class="keyword">if</span> (watchedEvent.getState() == Event.KeeperState.SyncConnected) &#123;</span><br><span class="line">                    connectLoatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 已成功监听waitLoatch,且当前节点被删除</span></span><br><span class="line">                <span class="keyword">if</span> (watchedEvent.getType() == Event.EventType.NodeDeleted &amp;&amp; watchedEvent.getPath().equals(waitPath)) &#123;</span><br><span class="line">                    waitLoatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        connectLoatch.await();  <span class="comment">// 等待zk正常连接，才运行下面的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.判断根结点/locks存在</span></span><br><span class="line">        <span class="type">Stat</span> <span class="variable">exists</span> <span class="operator">=</span> zk.exists(<span class="string">&quot;/locks&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (exists == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 创建根结点</span></span><br><span class="line">            zk.create(<span class="string">&quot;/locks&quot;</span>, <span class="string">&quot;locks&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="comment">// 创建临时序号节点</span></span><br><span class="line">        curNode = zk.create(<span class="string">&quot;/locks/seq-&quot;</span>, <span class="literal">null</span>, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">        <span class="comment">// 判断是否最小的，是获得锁，否监听前一个节点</span></span><br><span class="line">        List&lt;String&gt; children = zk.getChildren(<span class="string">&quot;/locks&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (children.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Collections.sort(children);</span><br><span class="line">            <span class="comment">// 获取当前节点名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">curNodeName</span> <span class="operator">=</span> curNode.substring(<span class="string">&quot;/locks/&quot;</span>.length());</span><br><span class="line">            <span class="comment">// 获取当前节点在children中的位置</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> children.indexOf(curNodeName);</span><br><span class="line">            <span class="comment">// 判断大小</span></span><br><span class="line">            <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;数据异常&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pos == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 监听前一个节点</span></span><br><span class="line">                waitPath = <span class="string">&quot;/locks/&quot;</span> + children.get(pos - <span class="number">1</span>);</span><br><span class="line">                zk.getData(waitPath,<span class="literal">true</span>,<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">// 这里是等待上一个节点释放锁，当前节点才能获得锁</span></span><br><span class="line">                waitLoatch.await();</span><br><span class="line">                <span class="comment">// 走到这里说明当前节点获得到了锁，不理解多看几遍</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException &#123;</span><br><span class="line">        <span class="comment">// 删除节点</span></span><br><span class="line">        zk.delete(curNode,-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">线程<span class="number">1</span>启动，获取到锁</span><br><span class="line">线程<span class="number">1</span>，释放锁</span><br><span class="line">线程<span class="number">2</span>启动，获取到锁</span><br><span class="line">线程<span class="number">2</span>，释放锁</span><br></pre></td></tr></table></figure>



<h2 id="Curator框架实现分布式锁"><a href="#Curator框架实现分布式锁" class="headerlink" title="Curator框架实现分布式锁"></a>Curator框架实现分布式锁</h2><p>1 ）、原生Java API开发存在的问题</p>
<ol>
<li>会话连接异步，需要自己处理。比如CountDownLatch</li>
<li>Watch需要重复注册</li>
<li>开发复杂</li>
<li>不支持多节点删除、创建，需要自己递归</li>
</ol>
<p>2 ）、Curator专门解决分布式锁的框架，解决了Java API的问题</p>
<h3 id="具体实现-2"><a href="#具体实现-2" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sugar.case3;</span><br><span class="line"><span class="keyword">import</span> org.apache.curator.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CuratorLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建锁1</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(getCurFranmeWork(), <span class="string">&quot;/locks&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建锁2</span></span><br><span class="line">        <span class="type">InterProcessMutex</span> <span class="variable">lock2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(getCurFranmeWork(), <span class="string">&quot;/locks&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程1</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock1.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1获得锁&quot;</span>);</span><br><span class="line">                    lock1.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1再次获得锁&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                    lock1.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1释放锁&quot;</span>);</span><br><span class="line">                    lock1.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程1再次释放锁&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程2</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock2.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2获得锁&quot;</span>);</span><br><span class="line">                    lock2.acquire();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2再次获得锁&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                    lock2.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2释放锁&quot;</span>);</span><br><span class="line">                    lock2.release();</span><br><span class="line">                    System.out.println(<span class="string">&quot;线程2再次释放锁&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CuratorFramework <span class="title function_">getCurFranmeWork</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 连接失败，间隔3s重新连接，重复三次</span></span><br><span class="line">        <span class="type">ExponentialBackoffRetry</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExponentialBackoffRetry</span>(<span class="number">3000</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">client</span> <span class="operator">=</span> CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(<span class="string">&quot;zkServer1:2181,zkServer2:2181,zkServer3:2181&quot;</span>)</span><br><span class="line">                .connectionTimeoutMs(<span class="number">2000</span>)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">2000</span>)</span><br><span class="line">                .retryPolicy(policy).build();</span><br><span class="line">        <span class="comment">// 启动客户端</span></span><br><span class="line">        client.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;客户端启动&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">线程<span class="number">1</span>获得锁</span><br><span class="line">线程<span class="number">1</span>再次获得锁</span><br><span class="line">线程<span class="number">1</span>释放锁</span><br><span class="line">线程<span class="number">1</span>再次释放锁</span><br><span class="line">线程<span class="number">2</span>获得锁</span><br><span class="line">线程<span class="number">2</span>再次获得锁</span><br><span class="line">线程<span class="number">2</span>释放锁</span><br><span class="line">线程<span class="number">2</span>再次释放锁</span><br></pre></td></tr></table></figure>



<h1 id="企业面试真题（面试重点）"><a href="#企业面试真题（面试重点）" class="headerlink" title="企业面试真题（面试重点）"></a>企业面试真题（面试重点）</h1><h2 id="选举机制"><a href="#选举机制" class="headerlink" title="选举机制"></a>选举机制</h2><p>半数机制，超过半数投票通过，则通过</p>
<p>（1）第一次启动</p>
<p>​    投票过半数，myid大的胜出</p>
<p>（2）第二次启动</p>
<p>​    Epoch &gt; zxid &gt; myid</p>
<h2 id="生产集群安装多少台zk合适？"><a href="#生产集群安装多少台zk合适？" class="headerlink" title="生产集群安装多少台zk合适？"></a>生产集群安装多少台zk合适？</h2><p>安装技术台</p>
<ul>
<li>10台服务器，3台zk</li>
<li>20台服务器，5台zk</li>
<li>100台服务器，11台zk</li>
<li>200台服务器，11台zk</li>
</ul>
<p>服务器台数多：好处，提高可靠性。坏处，提高通信延时</p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>ls、get、create、delete</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：Zookeeper实现</li>
        <li>Post author：Sugar</li>
        <li>Create time：2021-10-03 12:35:00</li>
        <li>
            Post link：https://keep.xpoet.cn/2021/10/03/Zookeeper案例/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/RPC/">#RPC</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">#分布式锁</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%8A%A8%E6%80%81%E4%B8%8A%E4%B8%8B%E7%BA%BF%E7%9B%91%E5%90%AC/">#动态上下线监听</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/10/03/Zookeeper%E6%BA%90%E7%A0%81/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Zookeeper源码</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/09/07/%E7%BB%93%E6%9E%84%E5%8C%96%E7%BB%91%E5%AE%9A%E8%A7%A3%E5%8C%85%E8%BF%94%E5%9B%9E%E5%80%BC/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">结构化绑定解包返回值</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Sugar</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>





    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
</div>



</body>
</html>
